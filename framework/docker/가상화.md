# 가상화

## 가상화 기술

- 정의 : 물리적인 컴퓨터 자원을 논리적으로 분리하여 여러 개의 독립적인 환경에서 활용할 수 있도록 사용하는 기술
- 배경
  - 초기 IT환경에서는 애플리케이션 및 서비스를 실행하기 위해 물리적인 서버를 각각 구매해야 했다
  - 서버 자원의 낭비(CPU 및 메모리) 및 비용 문제 발생
  - 이를 해결하기 위해 가상화 기술을 도입하여 IT 인프라 운영 효율성이 증대되었다
- 목적
  - 자원의 효율적 사용
  - 비용 절감 및 운영 단순화
  - 유연한 시스템 구축
  - 장애 시 빠른 복구 및 고가용성을 제공

## 하이퍼바이저(Hyporvisor)

- **정의 : 가상머신(Virtual Machine, VM)과 물리적 하드웨어 간의 자원 관리를 담당하는 소프트웨어**
- 역할
  - CPU, 메모리, 네트워크, 디스크 등 자원을 VM에 분배 및 할당
  - VM 간 충돌 방지
  - 물리적 자원을 효율적으로 활용하고 독립적인 운영체제를 실행 가능하게 한다
- 유형
  - **1형 하이퍼바이저**
    - 하드웨어 위에서 직접 실행
    - 운영체제없이 하드웨어와 직접 통신
    - 베어메탈 하이퍼바이저라고도 불림
    - 장점
      - 성능과 안전성이 2형에 비해 뛰어남
      - 자원 관리 효율성이 좋음
    - 단점
      - 초기 설정 및 설치가 복잡
    - 예시
      - VMware vSphere
      - Microsoft Hyper-V
  - **2형 하이퍼바이저**
    - 호스트 운영체제 위에서 실행
    - 호스트 하이퍼바이저라고도 불림
    - 장점
      - 설치 및 사용이 쉬움
      - 개발 및 테스트 환경에서 유용
    - 단점
      - 성능이 1형 하이퍼바이저에 비해 떨어짐
      - 물리적 하드웨어에 직접 접근하지 못함
    - 예시
      - Oracle VirtualBox
      - VMware Workstation

## 가상 머신(Virtual Machine, VM)

### **1. 가상 머신의 개념**

- **가상 머신(Virtual Machine, VM)**은 물리적인 컴퓨터 하드웨어를 소프트웨어적으로 구현하여, 독립적인 컴퓨터 환경을 제공하는 기술이다
- 물리적 하드웨어를 논리적으로 분리하거나 복제하여 하나의 물리적 컴퓨터에서 여러 대의 가상 컴퓨터를 실행할 수 있다
- VM은 **게스트 운영체제(Guest OS)**를 실행할 수 있는 독립된 환경을 제공하며, 각 가상 머신은 독립적으로 CPU, 메모리, 네트워크, 디스크와 같은 리소스를 할당받아 작동한다
  - 원래 컴퓨터가 사용하는 운영체제를 호스트 운영체제, VM에서 사용하는 운영체제를 게스트 운영쳊제라고 한다

### **2. 가상 머신의 구성 요소**

1. **하드웨어 가상화**
   - 가상 머신은 **물리적 하드웨어(CPU, 메모리, 디스크 등)를 소프트웨어적으로 구현하여 사용**한다
     - 하드웨어를 가상화
   - 예를 들어, 하나의 물리적 CPU를 여러 가상 CPU로 나눠 각 VM에 할당하는 식
2. **하이퍼바이저(Hypervisor)**
   - 하이퍼바이저는 물리적 하드웨어와 가상 머신 사이에서 자원 할당과 관리를 담당하는 소프트웨어
   - 하이퍼바이저가 하드웨어를 추상화하여 여러 가상 머신이 독립적으로 실행되도록 함
3. **게스트 운영체제(Guest OS)**
   - VM에서 실행되는 운영체제로, 물리적인 컴퓨터에 설치된 OS처럼 동작한다
   - 예: Windows, Linux, macOS 등
4. **가상 디스크**
   - 가상 머신의 저장 공간으로, 물리적 디스크의 일부를 파일 형태로 분리하여 사용
   - VM의 데이터와 운영체제가 여기에 저장된다
5. **네트워크 가상화**
   - 가상 머신은 독립적인 IP 주소를 가지며, 실제 네트워크와 통신할 수 있도록 가상 네트워크 어댑터를 사용한다

### **3. 가상 머신의 특징**

1. **독립성**
   - 각 VM은 독립적으로 동작하며, 다른 VM이나 호스트 시스템의 영향을 받지 않음
   - 예: 한 VM에서 운영체제가 다운되더라도 다른 VM에는 영향을 주지 않음
2. **유연성**
   - 하나의 물리적 하드웨어에서 여러 운영체제 실행 가능
   - 운영체제를 자유롭게 설치하고, 테스트 환경을 쉽게 구축 가능
3. **이식성**
   - VM은 파일 형태로 저장되기 때문에 다른 물리적 서버로 쉽게 이동 가능
4. **자원 격리**
   - CPU, 메모리, 디스크 등 자원이 VM별로 분리되어 관리됨
5. **자원 활용의 효율성**
   - 물리적 하드웨어의 자원을 효율적으로 활용하여, 사용하지 않는 자원을 다른 VM에 할당 가능

### **4. 가상 머신의 동작 방식**

1. **하드웨어 자원 추상화**
   - 하이퍼바이저가 물리적 하드웨어를 가상화하여, 각각의 VM이 **마치 독립된 하드웨어를 사용하는 것처럼 동작**
2. **운영체제 설치 및 실행**
   - 각 VM에 게스트 운영체제를 설치하여 실행
   - 호스트 OS와 게스트 OS 간의 완전한 독립성 보장
3. **자원 동적 할당**
   - CPU, 메모리, 네트워크 등의 자원이 가상화되어 필요에 따라 동적으로 할당

## 리눅스 컨테이너(Linux Container, LXC)

### 1. 리눅스 컨테이너 개념

- **리눅스 컨테이너는 운영체제 수준에서의 가상화 기술,** 애플리케이션과 그 실행 환경을 독립적으로 격리하여 실행할 수 있는 경량화된 가상화 기술
- 가상머신과 달리 전체 운영체제를 가상화하지않고(모든 하드웨어를 가상화 하지 않고) **호스트 운영체제의 커널을 공유하여 실행**
- 각 컨테이너는 자체적으로 격리된 환경에서 동작, 독립적인 파일 시스템, 네트워크, 프로세스를 갖는 것처럼 보이지만 실제로는 하나의 커널을 공유해서 사용

### 2. 리눅스 컨테이너 특징

- 경량성
  - 컨테이너는 전체 운영체제를 포함하지 않고 애플리케이션 실행에 필요한 라이프러리나 의존성만 포함하므로 가상머신보다 자원 소모가 적다
  - 실행 속도가 빠르고 시스템 부하가 적다
- 호스트 커널 공유
  - 컨테이너는 호스트 운영 체제의 커널을 공유하며 별도의 게스트 운영체제가 필요하지 않음
  - 부팅 시간이 짧고 리소스 사용량이 적다
- 격리
  - 각 컨테이너는 파일 시스템, 프로세스, 네트워크 등을 독립적으로 운영
  - 컨테이너 간 자원이 격리되어 있어 보안성이 향상됨
- 이식성
  - **컨테이너는 애플리케이션과 실행 환경을 하나의 단위로 패키징 하므로 개발 환경과 배포 환경의 차이를 최소화 시킨다**

### 3. 리눅스 컨테이너의 주요 구성 요소

- **cgroups(Control Groups)**
  - 리눅스 커널 기능으로, 프로세스 그룹에 대해 CPU, 메모리, 디스크 I/O 등의 자원을 제한하거나 할당하는 기술
  - 각 컨테이너가 사용 가능한 자원을 명확히 정의하여 과도한 자원 사용으로 인한 시스템 성능 저하를 방지
- **namespace**
  - 리눅스 커널의 기능으로, 프로세스가 보이는 리소스를 독립적으로 분리
  - 각 컨테이너는 독립된 파일 시스템, 네트워크 인터페이스, 프로세스 ID 공간 등을 가짐
  - PID namespace, Network namespace, Mount namespace 등등
- **chroot(파일 시스템 격리)**
  - 컨테이너의 파일 시스템을 호스트와 분리하기 위해 사용
  - 각 컨테이너는 독립된 루트 파일 시스템을 가진다. 이를 통해 격리된 환경 제공

### 4. 리눅스 커널과의 관계

1. **리눅스 커널**
   - 리눅스 **커널(Linux Kernel)**은 운영 체제의 핵심 구성 요소로, 하드웨어와 소프트웨어 간의 상호작용을 관리
   - **주요 역할**
     - CPU, 메모리, 네트워크 등의 하드웨어 자원 관리
     - 프로세스, 파일 시스템, 네트워크 통신 등 시스템 자원 제공
   - 컨테이너는 리눅스 커널의 기능을 기반으로 하여 동작한다
2. **컨테이너와 커널 공유**
   - 컨테이너는 리눅스 커널을 공유하므로, 호스트 커널 위에서 독립된 애플리케이션 실행 환경을 제공
   - 별도의 게스트 커널이 필요하지 않아 성능에 유리함
3. **cgroups와 namespace 활용**
   - **cgroups**: 컨테이너가 사용할 수 있는 자원을 제한
   - **namespace**: 컨테이너 간에 프로세스 ID, 네트워크 인터페이스, 마운트 포인트 등을 분리하여 격리된 환경 제공

## WSL(Windows Subsystem for Linux)

- **정의** : Windows에서 Linux 명령어와 소프트웨어를 실행할 수 있도록 지원하는 기능
- **특징**
  - WSL1
    - Windows 커널에서 Linux 시스템 호출을 번역
  - WSL2
    - 경량화된 가상 머신을 실행하여 실제 Linux 커널 기반으로 동작
- **장점**
  - 듀얼 부팅이나 별도의 VM 없이 Linux 환경 제공
  - Windows와 Linux 파일 시스템 및 네트워크 공유 가능
  - Microsoft Store에서 Linux 배포판(Ubuntu 등)을 다운로드 후 설치 가능

## 가상머신과 컨테이너 비교

| **항목**        | **가상 머신(VM)**                 | **컨테이너(Container)**               |
| --------------- | --------------------------------- | ------------------------------------- |
| **운영체제**    | 각 VM에 별도의 게스트 OS 필요     | 호스트 OS의 커널 공유                 |
| **자원 격리**   | 완전한 격리 제공                  | 프로세스 수준 격리                    |
| **부팅 시간**   | 몇 분 소요                        | 몇 초 내외                            |
| **자원 사용량** | 상대적으로 높음                   | 상대적으로 낮음                       |
| **유연성**      | 다양한 운영체제 실행 가능         | 애플리케이션 중심 실행 환경 제공      |
| **사용 사례**   | 복잡한 환경 시뮬레이션, OS 테스트 | 마이크로서비스, 경량화된 애플리케이션 |

## 윈도우에서 Docker 사용하기

### **윈도우에서 Docker와 Hyper-V의 역할**

1. **리눅스 컨테이너는 리눅스 커널 의존성**
   - Docker의 컨테이너는 리눅스 커널을 공유하는 방식으로 작동한다
   - 윈도우는 리눅스 커널이 없으므로 컨테이너를 실행하려면 리눅스 환경이 필요함
2. **Hyper-V를 통한 리눅스 환경 제공**
   - Hyper-V는 마이크로소프트의 **1형 하이퍼바이저**로, 윈도우에서 VM을 생성할 수 있다
   - Docker Desktop for Windows는 Hyper-V를 사용하여 **경량화된 리눅스 VM**을 실행한다
   - 이 VM 내에서 리눅스 커널과 Docker 엔진이 동작하여 리눅스 컨테이너를 실행할 수 있는 환경을 제공
3. **WSL2와의 협력 (최근 업데이트)**
   - Docker Desktop은 Hyper-V뿐 아니라 **WSL2(Windows Subsystem for Linux 2)**와도 연동이 가능
   - WSL2는 실제 리눅스 커널을 사용하는 경량화된 VM으로, Docker와 완벽히 통합된다
   - WSL2를 활성화하면 Docker는 WSL2를 통해 리눅스 커널에 접근하고, 컨테이너를 실행할 수 있다

### **윈도우에서 Docker 사용 시 선택**

1. **Hyper-V 기반 Docker**
   - Hyper-V를 활성화하여 Docker를 실행
   - Hyper-V를 사용하면 Windows와 Linux 컨테이너 모두 실행 가능
   - 단, Hyper-V는 다른 하이퍼바이저(예: VirtualBox)와의 호환성 문제가 있을 수 있음
2. **WSL2 기반 Docker**
   - 최신 Docker Desktop은 WSL2를 기본 선택으로 제공합
   - Hyper-V 대신 WSL2를 활성화하여 Docker 컨테이너를 실행
   - WSL2는 더 적은 자원으로 높은 성능을 제공하며, 기존 리눅스 개발 환경과 자연스럽게 통합 가능

### **WSL2와 하이퍼바이저의 관계**

1. **WSL2는 리눅스 커널 기반 환경**
   - WSL2는 마이크로소프트가 만든 실제 리눅스 커널을 포함한 환경으로, 리눅스 애플리케이션을 실행할 수 있도록 설계되다
   - 기존 WSL1은 시스템 호출(System Call)을 번역하여 윈도우 커널에서 리눅스 애플리케이션을 실행했지만, WSL2는 이를 가상화된 리눅스 환경에서 실행한다
2. **Hyper-V를 사용**
   - WSL2는 **Hyper-V** 기술을 사용하여 경량화된 리눅스 VM을 실행한다
   - 이 VM은 리눅스 커널을 포함하고 있으며, 매우 빠른 부팅 시간과 적은 자원을 사용한다
   - Hyper-V를 사용하지만, WSL2는 개발자가 직접 VM을 관리하거나 설정하지 않아도 된다
3. **하이퍼바이저는 Hyper-V**
   - WSL2의 리눅스 환경은 Hyper-V 하이퍼바이저 위에서 동작한다
   - Hyper-V는 WSL2의 기반 기술로, 실제 하드웨어 자원을 리눅스 VM에 분배하는 역할을 한다
   - 결과적으로, WSL2는 자체적으로 하이퍼바이저가 아니라, 하이퍼바이저(Hyper-V) 위에서 동작하는 **리눅스 환경이다**

### **WSL2의 특징**

- **하이퍼바이저가 아닌 이유**
  - WSL2는 하이퍼바이저처럼 하드웨어 자원을 직접 분배하거나 관리하지 않는다
  - 대신, Hyper-V 하이퍼바이저를 통해 제공된 리소스를 사용한다
- **개발자 경험에 최적화**
  - 하이퍼바이저를 사용하는 전통적인 가상화(VM) 환경보다 설정과 관리가 훨씬 간단하다
  - 리눅스 배포판(Ubuntu, Debian 등)을 Windows 환경에서 직접 설치하고 실행할 수 있다
