## 트랜잭션과 Flush

### 트랜잭션 (Transaction)

- `EntityManager` 는 트랜잭션 단위로 작업 수행
- 트랜잭션이 커밋될 때 영속성 컨텍스트의 변경 사항이 데이터베이스에 반영됨

### Flush

- `flush()` 는 영속성 컨텍스트의 변경 사항을 데이터베이스에 즉시 반영하는 메서드
- 트랜잭션 커밋 시 자동으로 호출 됨
- 액션 큐에 있는 sql들이 차례로 실행되고 액션 큐를 비움

### 액션 큐(Action Queue)의 역할

액션 큐는 JPA 내부에서 SQL문을 임시로 저장하는 메모리 공간이다

1. SQL 저장
   1. `INSERT`, `UPDATE` , `DELETE` 문은 데이터베이스에 즉시 실행되지 않고 액션 큐에 저장
2. 실행 순서 관리
   1. 트랜잭션 커밋 시 저장된 SQL 실행
   2. 저장된 순서와 엔티티 관계를 기반으로 적절한 순서를 정함
3. 중복 SQL 제거
   1. 같은 엔티티에 대해 여러번 수정할 경우 마지막 수정 내용만 남기고 이전 내용은 무시한다

### 장점

1. 성능 최적화
   1. 여러 SQL 문을 한 번에 배치 처리로 실행하여 데이터베이스와의 통신 횟수를 줄임
2. 트랜잭션 내 작업 보장
   1. 트랜잭션이 커밋될 경우에만 SQL이 실행되므로 중간 작업 중 문제가 발생하면 데이터베이스에 반영하지 않는다
3. 데이터 무결성 보장
   1. 엔티티 간 연관 관계를 올바르게 처리

### 주의점

1. Flush 시점
   1. 트랜잭션 커밋 전에 명시적으로 `em.flush()` 호출 시 SQL 즉시 실행
   2. 커밋 전에 실행된 SQL은 롤백되지 않음
2. 메모리 사용량
   1. 액션 큐에 많은 SQL이 쌓일 경우 메모리 사용량이 증가한다
   2. 대량 데이터 처리는 배치 전략을 사용해야 한다
3. Lazy Loading과 결합
   1. 연관 엔티티를 지연 로딩으로 설정할 경우 액션 큐에서 실행 순서가 어긋날 수도 있다
   2. 명시적으로 로딩하거나 Fetch Join을 하는게 안전하다
