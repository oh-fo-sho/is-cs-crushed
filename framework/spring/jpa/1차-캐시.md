## 1차 캐시

1차 캐시는 JPA 표준 명세에 포함된 개념, 당연히 하이버네이트도 이를 따른다.

JPA 표준 명세에는 **영속성 컨텍스트의 개념이 있으며 1차 캐시는 영속성 컨텍스트 내부에서 관리된다.**

### 1차 캐시 위치

- 1차 캐시는 엔티티 매니저(EntityManager) 인스턴스 내부에 존재하며 영속성 컨텍스트의 일부로 동작한다
- 동일한 `EntityManager` 를 사용하는 동안 같은 엔티티를 조회하거나 수정하면 데이터베이스에 직접 접근하지 않고 1차 캐시에 저장된 데이터를 사용한다

### 1차 캐시 특징

1차 캐시는 **엔티티 매니저 단위로 동작**하며 엔티티의 상태를 관리한다

1. **캐시 기본 동작**
   - `find()` 또는 `getReference()` 메서드로 엔티티를 조회하면, 엔티티 매니저는 먼저 1차 캐시에서 해당 엔티티를 찾는다
   - 1차 캐시에 없다면 데이터베이스에서 조회 후 1차 캐시에 저장한다
2. **동일성 보장**
   - 동일한 `EntityManager` 내에서 동일한 엔티티는 같은 메모리 주소를 가진다
   - 같은 엔티티를 두 번 조회해도 동일한 인스턴스가 반환됩니다
3. **자동 쓰기 지연**
   - 변경된 엔티티는 트랜잭션 커밋 시점에 1차 캐시에서 데이터베이스로 플러시(Flush)
   - 데이터베이스와의 실제 상호작용을 최소화한다
4. **관리되는 엔티티만 포함**
   - 1차 캐시에는 영속 상태(managed)의 엔티티만 포함
   - 준영속(detached) 또는 비영속(transient) 상태의 엔티티는 포함되지 않음
5. **트랜잭션 범위**
   - 1차 캐시는 트랜잭션 범위 내에서만 유지
   - `EntityManager`가 닫히면 1차 캐시도 사라진다

### 1차 캐시 생명주기

1차 캐시는 영속성 컨텍스트와 동일한 생명주기를 갖는다

1. **트랜잭션과 1차 캐시의 생성**
   - `EntityManager`를 통해 트랜잭션이 시작되면, 그 시점에서 1차 캐시(영속성 컨텍스트)가 활성화된다
   - 이때 `EntityManager`는 데이터베이스와의 상호작용 없이 1차 캐시를 활용
2. **트랜잭션과 1차 캐시의 소멸**
   - 트랜잭션이 종료(커밋 또는 롤백)되면, 영속성 컨텍스트와 1차 캐시도 함께 사라진다
     - flush는 아님
   - `EntityManager`를 닫거나(명시적으로 `em.close()` 호출), `EntityManager`가 더 이상 유효하지 않으면 1차 캐시도 사라진다

<aside>

대부분의 경우, 엔티티 매니저, 영속성 컨텍스트, 1차 캐시는 동일한 생명주기를 가진다. 엔티티 매니저가 생성되면 영속성 컨텍스트와 1차 캐시가 생성되고, 엔티티 매니저가 닫히면 함께 소멸되기 때문이다.
트랜잭션은 1차 캐시에서 변경된 데이터를 데이너베이스에 동기화(flush)하는 단위이다. 트랜잭션이 끝나면 커밋되거나 롤백되고 1차캐시는 정리된다

</aside>
